name: Auto-Close Detector (Reusable)

on:
  workflow_call:
    inputs:
      project_id:
        description: 'Firestore project ID (optional, for multi-tenant)'
        required: false
        type: string
        default: ''
      ai_analysis_enabled:
        description: 'Enable AI-based commit analysis (Phase 3)'
        required: false
        type: boolean
        default: true
      ai_confidence_threshold:
        description: 'AI confidence threshold (0.0-1.0)'
        required: false
        type: string
        default: '0.7'
    secrets:
      FIREBASE_SERVICE_ACCOUNT_KEY:
        description: 'Firebase Service Account JSON Key'
        required: true
      OPENAI_API_KEY:
        description: 'OpenAI API Key for GPT-4o'
        required: true
      GCP_PROJECT_ID:
        description: 'Google Cloud Project ID'
        required: true
      GCP_WIF_PROVIDER:
        description: 'GCP Workload Identity Provider'
        required: false
      GCP_SA_EMAIL:
        description: 'GCP Service Account Email'
        required: false

jobs:
  auto-close:
    name: Detect and Close Completed Todos
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # ç›´è¿‘50ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Google Cloud credentials
        run: |
          # FIREBASE_SERVICE_ACCOUNT_KEYã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > ${{ github.workspace }}/service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/service-account-key.json" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud (Workload Identity)
        continue-on-error: true
        if: secrets.GCP_WIF_PROVIDER != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Run 3-Phase Auto-Close Detection
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          PROJECT_ID: ${{ inputs.project_id }}
          REPOSITORY: ${{ github.repository }}
          AI_ANALYSIS_ENABLED: ${{ inputs.ai_analysis_enabled }}
          AI_CONFIDENCE_THRESHOLD: ${{ inputs.ai_confidence_threshold }}
          PHASE2_AI_ENABLED: 'true'
          PHASE2_CONFIDENCE_THRESHOLD: '0.5'
        run: |
          echo "=========================================="
          echo "ğŸ¤– 3æ®µéšãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºåˆ¤å®š"
          echo "=========================================="
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸ‘¤ ãƒ—ãƒƒã‚·ãƒ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${{ github.actor }}"
          echo "ğŸ“ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "ğŸ¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: ${{ inputs.project_id || '(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)' }}"
          echo "ğŸ¤– AIè§£æ: ${{ inputs.ai_analysis_enabled }}"
          echo "ğŸ“Š AIä¿¡é ¼åº¦é–¾å€¤: ${{ inputs.ai_confidence_threshold }}"
          echo ""

          node tests/analyze-commit.js

          echo ""
          echo "âœ… è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºåˆ¤å®šå®Œäº†"
          echo ""
          echo "ğŸ“‹ åˆ¤å®šæ–¹å¼:"
          echo "  Phase 1: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£æï¼ˆç¢ºå®Ÿæ€§100%ï¼‰ â†’ å®Œå…¨ã‚¯ãƒ­ãƒ¼ã‚º"
          echo "  Phase 2: ãƒ•ã‚¡ã‚¤ãƒ«åç…§åˆ + è»½é‡AIåˆ¤å®šï¼ˆä¿¡é ¼åº¦ â‰¥ 0.5ï¼‰ â†’ ã‚¯ãƒ­ãƒ¼ã‚ºå€™è£œ"
          echo "  Phase 3: å®Œå…¨AIå·®åˆ†è§£æï¼ˆGPT-4oã€ä¿¡é ¼åº¦ â‰¥ 0.7ï¼‰ â†’ ã‚¯ãƒ­ãƒ¼ã‚ºå€™è£œ"
          echo ""
          echo "ğŸŒ ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ToDoã®ã‚¯ãƒ­ãƒ¼ã‚ºå€™è£œã‚’ç¢ºèªã—ã¦ãã ã•ã„"

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“Š è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºåˆ¤å®šã‚µãƒãƒªãƒ¼"
          echo "=========================================="
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ‘¤ ãƒ—ãƒƒã‚·ãƒ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${{ github.actor }}"
          echo ""
          echo "è©³ç´°ãªãƒ­ã‚°ã¯ä¸Šè¨˜ã®ã€ŒRun 3-Phase Auto-Close Detectionã€ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
