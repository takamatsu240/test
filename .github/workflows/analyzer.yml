name: Minutes Analyzer (Reusable)

on:
  workflow_call:
    inputs:
      files_pattern:
        description: 'Pattern for minutes files to analyze (e.g., minutes/**/*.{docx,md})'
        required: false
        type: string
        default: 'minutes/**/*.{docx,md}'
      project_id:
        description: 'Firestore project ID (optional, for multi-tenant)'
        required: false
        type: string
        default: ''
      analyze_mode:
        description: 'Analysis mode: auto (detect file type) | markdown-only | word-only'
        required: false
        type: string
        default: 'auto'
    secrets:
      FIREBASE_SERVICE_ACCOUNT_KEY:
        description: 'Firebase Service Account JSON Key'
        required: true
      OPENAI_API_KEY:
        description: 'OpenAI API Key for GPT-4o'
        required: true
      GCP_PROJECT_ID:
        description: 'Google Cloud Project ID'
        required: true
      GCP_WIF_PROVIDER:
        description: 'GCP Workload Identity Provider'
        required: false
      GCP_SA_EMAIL:
        description: 'GCP Service Account Email'
        required: false

jobs:
  analyze:
    name: Analyze Minutes
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ==================== Wordâ†’Markdownå¤‰æ› ====================

      - name: Set up Python for Word conversion
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        run: |
          pip install python-docx

      - name: Detect changed minutes files
        id: changed_files
        run: |
          echo "=========================================="
          echo "è­°äº‹éŒ²ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºé–‹å§‹"
          echo "=========================================="
          echo "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          echo ""

          # ã‚³ãƒŸãƒƒãƒˆã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
          CHANGED_DOCX=""
          CHANGED_MD=""

          # .docxãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºï¼ˆãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã€å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–ï¼‰
          if [[ "${{ inputs.analyze_mode }}" != "markdown-only" ]]; then
            echo "ğŸ“„ Word(.docx)ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºä¸­..."
            CHANGED_DOCX=$(git diff --name-only --diff-filter=d HEAD~1 HEAD | grep -E '^minutes/.*\.docx$' || echo "")
            CHANGED_DOCX=$(echo "$CHANGED_DOCX" | xargs)

            if [ -n "$CHANGED_DOCX" ]; then
              echo "æ¤œå‡ºã•ã‚ŒãŸWordãƒ•ã‚¡ã‚¤ãƒ«: '$CHANGED_DOCX'"
            else
              echo "ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸWordãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
            fi
          fi

          # .mdãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºï¼ˆå‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–ï¼‰
          if [[ "${{ inputs.analyze_mode }}" != "word-only" ]]; then
            echo ""
            echo "ğŸ“ Markdown(.md)ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºä¸­..."
            CHANGED_MD=$(git diff --name-only --diff-filter=d HEAD~1 HEAD | grep -E '^minutes/.*\.md$' || echo "")

            # è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸ.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼ˆ[skip ci]ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚€ã‚³ãƒŸãƒƒãƒˆï¼‰
            if [ -n "$CHANGED_MD" ]; then
              COMMIT_MSG=$(git log -1 --pretty=%B)
              if [[ "$COMMIT_MSG" == *"[skip ci]"* ]]; then
                echo "  â­ï¸  è‡ªå‹•ç”Ÿæˆã‚³ãƒŸãƒƒãƒˆã®ãŸã‚.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—"
                CHANGED_MD=""
              fi
            fi

            CHANGED_MD=$(echo "$CHANGED_MD" | xargs)
            echo "æ¤œå‡ºã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«: '$CHANGED_MD'"
          fi

          echo ""
          echo "files_docx=$CHANGED_DOCX" >> $GITHUB_OUTPUT
          echo "files_md=$CHANGED_MD" >> $GITHUB_OUTPUT

          if [ -n "$CHANGED_DOCX" ]; then
            echo "has_docx=true" >> $GITHUB_OUTPUT
          else
            echo "has_docx=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "$CHANGED_MD" ]; then
            echo "has_md=true" >> $GITHUB_OUTPUT
          else
            echo "has_md=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "$CHANGED_DOCX" ] || [ -n "$CHANGED_MD" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Convert Word to Markdown
        if: steps.changed_files.outputs.has_docx == 'true'
        run: |
          echo "=========================================="
          echo "Word â†’ Markdown å¤‰æ›å®Ÿè¡Œ"
          echo "=========================================="

          for file in ${{ steps.changed_files.outputs.files_docx }}; do
            if [ ! -f "$file" ]; then
              echo "âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $file"
              continue
            fi

            filename=$(basename -- "$file")
            filename="${filename%.*}"
            output_file="minutes/${filename}.md"

            echo "ğŸ“ å¤‰æ›ä¸­: $file -> $output_file"
            python scripts/docx_to_md.py "$file" "$output_file"

            if [ $? -eq 0 ]; then
              echo "âœ… å¤‰æ›æˆåŠŸ: $output_file"
            else
              echo "âŒ å¤‰æ›å¤±æ•—: $file"
              exit 1
            fi
          done

      - name: Commit converted Markdown files
        if: steps.changed_files.outputs.has_docx == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # .mdãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿git add
          if ls minutes/*.md 1> /dev/null 2>&1; then
            git add minutes/*.md
          else
            echo "âš ï¸ .mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          if git diff --quiet && git diff --staged --quiet; then
            echo "å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "docs: Auto-convert minutes from Word to Markdown [skip ci]" \
                       -m "Automatically converted by analyzer.yml reusable workflow"

            # ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ã‹ã‚‰push
            git pull --rebase origin ${{ github.ref_name }}
            git push
            echo "âœ… Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥"
          fi

      # ==================== è­°äº‹éŒ²è§£æ ====================

      - name: Setup Node.js for analysis
        if: steps.changed_files.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js dependencies
        if: steps.changed_files.outputs.has_changes == 'true'
        run: npm ci

      - name: Setup Google Cloud credentials
        if: steps.changed_files.outputs.has_changes == 'true'
        run: |
          # FIREBASE_SERVICE_ACCOUNT_KEYã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > ${{ github.workspace }}/service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/service-account-key.json" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud (Workload Identity)
        continue-on-error: true
        if: steps.changed_files.outputs.has_changes == 'true' && secrets.GCP_WIF_PROVIDER != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Analyze minutes with AI
        if: steps.changed_files.outputs.has_changes == 'true'
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          PROJECT_ID: ${{ inputs.project_id }}
        run: |
          echo "=========================================="
          echo "è­°äº‹éŒ²AIè§£æå®Ÿè¡Œ"
          echo "=========================================="

          # è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†
          FILES_TO_ANALYZE=""

          # å¤‰æ›ã•ã‚ŒãŸWordãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã™ã‚‹.mdãƒ•ã‚¡ã‚¤ãƒ«
          if [ -n "${{ steps.changed_files.outputs.files_docx }}" ]; then
            for docx in ${{ steps.changed_files.outputs.files_docx }}; do
              filename=$(basename -- "$docx")
              filename="${filename%.*}"
              md_file="minutes/${filename}.md"

              if [ -f "$md_file" ]; then
                FILES_TO_ANALYZE="$FILES_TO_ANALYZE $md_file"
              fi
            done
          fi

          # ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸ.mdãƒ•ã‚¡ã‚¤ãƒ«
          if [ -n "${{ steps.changed_files.outputs.files_md }}" ]; then
            FILES_TO_ANALYZE="$FILES_TO_ANALYZE ${{ steps.changed_files.outputs.files_md }}"
          fi

          FILES_TO_ANALYZE=$(echo "$FILES_TO_ANALYZE" | xargs)

          if [ -z "$FILES_TO_ANALYZE" ]; then
            echo "âš ï¸ è§£æå¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          echo "ğŸ“‹ è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "$FILES_TO_ANALYZE"
          echo ""

          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
          for md_file in $FILES_TO_ANALYZE; do
            echo "ğŸ” è§£æä¸­: $md_file"
            node scripts/analyze-minutes.js \
              --file "$md_file" \
              --projectId "${{ inputs.project_id }}" \
              --commit "${{ github.sha }}" \
              --pushedBy "${{ github.actor }}"

            if [ $? -eq 0 ]; then
              echo "âœ… è§£ææˆåŠŸ: $md_file"
            else
              echo "âš ï¸ è§£æå¤±æ•—: $md_file"
            fi
            echo ""
          done

      - name: Summary
        if: steps.changed_files.outputs.has_changes == 'true'
        run: |
          echo "=========================================="
          echo "âœ… è­°äº‹éŒ²è‡ªå‹•è§£æå®Œäº†"
          echo "=========================================="
          echo ""
          echo "ğŸ“‹ å‡¦ç†ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"

          if [ -n "${{ steps.changed_files.outputs.files_docx }}" ]; then
            echo ""
            echo "ğŸ“„ å¤‰æ›ã•ã‚ŒãŸWordãƒ•ã‚¡ã‚¤ãƒ«:"
            for docx in ${{ steps.changed_files.outputs.files_docx }}; do
              filename=$(basename -- "$docx")
              filename="${filename%.*}"
              echo "  - $docx â†’ minutes/${filename}.md"
            done
          fi

          if [ -n "${{ steps.changed_files.outputs.files_md }}" ]; then
            echo ""
            echo "ğŸ“ ç›´æ¥è§£æã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«:"
            for md in ${{ steps.changed_files.outputs.files_md }}; do
              echo "  - $md"
            done
          fi

          echo ""
          echo "ğŸ” AIè§£æã‚‚å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ‘¤ ãƒ—ãƒƒã‚·ãƒ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${{ github.actor }}"
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo ""
          echo "ğŸŒ ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦æœªæ‰¿èªè­°äº‹éŒ²ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
